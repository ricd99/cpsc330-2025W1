
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 19: Time series &#8212; CPSC 330 Applied Machine Learning 2025W1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/extra.css?v=6df0ab2b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lectures/101-103-Giulia-lectures/19_time-series';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/UBC-CS-logo.png" class="logo__image only-light" alt="CPSC 330 Applied Machine Learning 2025W1 - Home"/>
    <script>document.write(`<img src="../../_static/UBC-CS-logo.png" class="logo__image only-dark" alt="CPSC 330 Applied Machine Learning 2025W1 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    UBC CPSC 330: Applied Machine Learning (2025W1)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Things you should know</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/README.html">CPSC 330 Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../learning-objectives.html">Course Learning Objectives</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../notes/01_intro.html">Lecture 1: Course Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/02_terminology-decision-trees.html">Lecture 2: Terminology, Baselines, Decision Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/03_ml-fundamentals.html">Lecture 3: Machine Learning Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/04_kNNs-SVM-RBF.html">Lecture 4: <span class="math notranslate nohighlight">\(k\)</span>-Nearest Neighbours and SVM RBFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/05_preprocessing-pipelines.html">Lecture 5: Preprocessing and <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/06_column-transformer-text-feats.html">Lecture 6: <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> and Text Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/07_linear-models.html">Lecture 7: Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/08_hyperparameter-optimization.html">Lecture 8: Hyperparameter Optimization and Optimization Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/09_classification-metrics.html">Lecture 9: Classification metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/10_regression-metrics.html">Lecture 10: Regression metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/11_ensembles.html">Lecture 11: Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/12_feat-importances.html">Lecture 12: Feature importances and model transparency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/13_feature-engineering-selection.html">Lecture 13: Feature engineering and feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/14_K-Means.html">Lecture 14: K-Means Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/15_DBSCAN-hierarchical.html">Lecture 15: More Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/16_recommender-systems.html">Lecture 16: Recommender Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/17_natural-language-processing.html">Lecture 17: Introduction to natural language processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/18_intro_to_computer-vision.html">Lecture 18: Multi-class classification and introduction to computer vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/19_time-series.html">Lecture 19: Time series</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/20_survival-analysis.html">Lecture 20: Survival analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/21_communication.html">Lecture 21: Communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/23_deployment-conclusion.html">Lecture 23: Deployment and conclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/final-exam-review-guiding-question.html">Final exam preparation: guiding questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/AppendixA.html">Appendix A: Handling class imbalance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/AppendixB.html">Appendix B: Feature Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/AppendixC.html">Appendix C: Basic text preprocessing [video]</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/AppendixD.html">Appendix D: Multi-class, meta-strategies</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Section slides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../102-Varada-lectures/README.html">Section 102</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-01.html">Lecture 1</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-02.html">Lecture 2</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-03.html">Lecture 3</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-04.html">Lecture 4</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-05.html">Lecture 5</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-06.html">Lecture 6</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-07.html">Lecture 7</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-08.html">Lecture 8</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-09.html">Lecture 9</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-10.html">Lecture 10</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-11.html">Lecture 11</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-12.html">Lecture 12</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-13.html">Lecture 13</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-14.html">Lecture 14</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-15.html">Lecture 15</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-16.html">Lecture 16</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-17.html">Lecture 17</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-18.html">Lecture 18</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-19.html">Lecture 19</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-20.html">Lecture 20</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-21.html">Lecture 21</a></li>
<li class="toctree-l2"><a class="reference external" href="https://kvarada.github.io/cpsc330-slides/lecture-23.html">Lecture 23</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Attribution</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">LICENSE</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/UBC-CS/cpsc330-2025W1" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/lectures/101-103-Giulia-lectures/19_time-series.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 19: Time series</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-lo">Imports and LO</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split-for-temporal-data">Train/test split for temporal data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-for-date-time-columns">Feature engineering for date/time columns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#posix-time-feature">POSIX time feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-date-and-time-information">Extracting date and time information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-time-of-day-as-a-categorical-feature">Encoding time of day as a categorical feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interim-summary">Interim summary</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-based-features">Lag-based features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation">Cross-validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future">Forecasting further into the future</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future-on-a-retail-dataset">Forecasting further into the future on a retail dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-and-trends">Seasonality and trends</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-remarks">Final remarks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#traditional-time-series-approaches">Traditional time series approaches</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-learning">Deep learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-problems-involving-time-series">Types of problems involving time series</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#unequally-spaced-time-points">Unequally spaced time points</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-software-package">Other software package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature engineering</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="" src="../../_images/330-banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="lecture-19-time-series">
<h1>Lecture 19: Time series<a class="headerlink" href="#lecture-19-time-series" title="Link to this heading">#</a></h1>
<p>UBC 2025-26</p>
<p><img alt="" src="../../_images/time-series-dall-e.png" /></p>
<p>The picture is created using DALL-E!</p>
<blockquote>
<div><p>This illustration shows a cityscape with skyscrapers, each featuring digital billboards displaying time-series graphs. These graphs represent various types of data such as stock market trends, weather patterns, and population growth, set against the backdrop of a bustling city with people of diverse descents and genders. This setting should provide a compelling and relatable context for your introduction to time-series lecture.</p>
</div></blockquote>
<section id="imports-and-lo">
<h2>Imports and LO<a class="headerlink" href="#imports-and-lo" title="Link to this heading">#</a></h2>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.dummy</span><span class="w"> </span><span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TimeSeriesSplit</span><span class="p">,</span>
    <span class="n">cross_val_score</span><span class="p">,</span>
    <span class="n">cross_validate</span><span class="p">,</span>
    <span class="n">train_test_split</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">),</span> <span class="s2">&quot;data/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="learning-objectives">
<h3>Learning objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Recognize when it is appropriate to use time series.</p></li>
<li><p>Explain the pitfalls of train/test splitting with time series data.</p></li>
<li><p>Appropriately split time series data, both train/test split and cross-validation.</p></li>
<li><p>Perform time series feature engineering:</p>
<ul>
<li><p>Encode time as various features in a tabular dataset</p></li>
<li><p>Create lag-based features</p></li>
</ul>
</li>
<li><p>Explain how can you forecast multiple time steps into the future.</p></li>
<li><p>Explain the challenges of time series data with unequally spaced time points.</p></li>
<li><p>At a high level, explain the concept of trend.</p></li>
</ul>
<p><br><br></p>
</section>
</section>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Time series</strong> is a collection of data points indexed in time order.</p></li>
<li><p>Time series is everywhere:</p>
<ul>
<li><p>Physical sciences (e.g., weather forecasting)</p></li>
<li><p>Economics, finance (e.g., stocks, market trends)</p></li>
<li><p>Engineering (e.g., energy consumption)</p></li>
<li><p>Social sciences</p></li>
<li><p>Sports analytics</p></li>
</ul>
</li>
</ul>
<p>Let’s start with a simple example from <a class="reference external" href="https://learning.oreilly.com/library/view/introduction-to-machine/9781449369880/">Introduction to Machine Learning with Python  book</a>.</p>
<p>In New York city there is a network of bike rental stations with a subscription system. The stations are all around the city. The anonymized data is available <a class="reference external" href="https://ride.citibikenyc.com/system-data">here</a>.</p>
<p>We will focus on the task is predicting how many people will rent a bicycle from a particular station for a given time and day. We might be interested in knowing this so that we know whether there will be any bikes left at the station for a particular day and time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">mglearn</span>

<span class="n">citibike</span> <span class="o">=</span> <span class="n">mglearn</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">load_citibike</span><span class="p">()</span>
<span class="n">citibike</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-01 00:00:00     3
2015-08-01 03:00:00     0
2015-08-01 06:00:00     9
2015-08-01 09:00:00    41
2015-08-01 12:00:00    39
Freq: 3h, Name: one, dtype: int64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The only feature we have is the date time feature.</p>
<ul>
<li><p>Example: 2015-08-01 00:00:00</p></li>
</ul>
</li>
<li><p>What’s the duration of the intervals?</p>
<ul>
<li><p>The data is collected at regular intervals (every three hours)</p></li>
</ul>
</li>
<li><p>The target is the number of rentals in the next 3 hours.</p>
<ul>
<li><p>Example: 3 rentals between 2015-08-01 00:00:00 and 2015-08-01 03:00:00</p></li>
</ul>
</li>
</ul>
<p><br><br></p>
<ul class="simple">
<li><p>We have a time-ordered sequence of data points.</p></li>
<li><p>This type of data is distinctive because it is inherently sequential, with an intrinsic order based on time.</p></li>
<li><p>The number of bikes available at a station at one point in time is often related to the number of bikes at earlier times.</p></li>
<li><p>This is a <strong>time-series forecasting</strong> problem.</p></li>
</ul>
<p>Let’s check the time duration of our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-31 21:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<p>We have data for August 2015. Let’s visualize our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">xticks</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">citibike</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rentals&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of bike rentals over time for a selected bike station&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/575cea363377d5845144f24429a6476986d5355a31a6f9b1b74d8f7d80ed485a.png" src="../../_images/575cea363377d5845144f24429a6476986d5355a31a6f9b1b74d8f7d80ed485a.png" />
</div>
</div>
<ul class="simple">
<li><p>We see the day and night pattern</p></li>
<li><p>We see the weekend and weekday pattern</p></li>
</ul>
<ul class="simple">
<li><p>Questions you might want to answer: How many people are likely to rent a bike at this station in the next three hours given everything we know about rentals in the past?</p></li>
<li><p>We want to learn from the past and predict the future.</p></li>
</ul>
<section id="questions-for-you">
<h3>❓❓ Questions for you<a class="headerlink" href="#questions-for-you" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Can we use our usual supervised machine learning methodology to predict the number of people who will rent bicycles from a specific station at a given time and date?</p></li>
<li><p>How can you adapt traditional machine learning methods for time series forecasting?</p></li>
</ul>
<p><br><br><br><br><br><br><br><br></p>
</section>
</section>
<section id="train-test-split-for-temporal-data">
<h2>Train/test split for temporal data<a class="headerlink" href="#train-test-split-for-temporal-data" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>To evaluate the model’s ability to generalize, we will divide the data into training and testing subsets.</p></li>
<li><p>What will happen if we split this data the usual way?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">citibike</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-26 12:00:00    30
2015-08-12 09:00:00    10
2015-08-19 03:00:00     2
2015-08-07 12:00:00    22
2015-08-03 09:00:00     9
Name: one, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8797cf77589072df168935081812f59441f0321423510e147aff041ffb64368d.png" src="../../_images/8797cf77589072df168935081812f59441f0321423510e147aff041ffb64368d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-31 21:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-01 12:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We are training on data that came after our test data!</p></li>
<li><p>If we want to forecast, <strong>we aren’t allowed to know what happened in the future</strong>!</p></li>
<li><p>There may be cases where this is OK, e.g. if you aren’t trying to forecast and just want to understand your data (maybe you’re not even splitting).</p></li>
<li><p>But, for our purposes, we want to avoid this.</p></li>
</ul>
<p>We’ll split the data as follows:</p>
<ul class="simple">
<li><p>We have total 248 data points.</p></li>
<li><p>We’ll use the fist 184 data points corresponding to the first 23 days as training data - And the remaining 64 data points corresponding to the remaining 8 days as test data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_train</span> <span class="o">=</span> <span class="mi">184</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">citibike</span><span class="p">[:</span><span class="mi">184</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">citibike</span><span class="p">[</span><span class="mi">184</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/560338067a84fc5ea865b1b1c4610d6613097f6b4b093db318e74c24f4467533.png" src="../../_images/560338067a84fc5ea865b1b1c4610d6613097f6b4b093db318e74c24f4467533.png" />
</div>
</div>
<p>This split is looking reasonable now. We’ll train our model on the blue part and evaluate it on the red part.</p>
<p><br><br></p>
</section>
<section id="feature-engineering-for-date-time-columns">
<h2>Feature engineering for date/time columns<a class="headerlink" href="#feature-engineering-for-date-time-columns" title="Link to this heading">#</a></h2>
<section id="id1">
<h3>❓❓ Questions for you<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>What kind of features would you create from time series data to use in a model like a random forest or SVM?</p></li>
</ul>
<p><br><br><br><br><br><br><br><br></p>
</section>
<section id="posix-time-feature">
<h3>POSIX time feature<a class="headerlink" href="#posix-time-feature" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>In this toy data, we just have a single feature: the date time feature.</p></li>
<li><p>We need to encode this feature if we want to build machine learning models.</p></li>
<li><p>A common way that dates are stored on computers is using POSIX time, which is the number of seconds since January 1970 00:00:00 (this is beginning of Unix time).</p></li>
<li><p>Let’s start with encoding this feature as a single integer representing this POSIX time.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
<span class="p">)</span>  <span class="c1"># convert to POSIX time by dividing by 10**9</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">citibike</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="note admonition">
<p class="admonition-title">Note</p>
<p>In pandas, datetime objects are typically represented as Timestamp objects, which internally store time as the number of nanoseconds (1 billionth of a second. 1 second = <span class="math notranslate nohighlight">\(10^9\)</span> nanoseconds) since the POSIX epoch (January 1, 1970, 00:00:00 UTC).</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># convert to POSIX time by dividing by 10**9</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1438387200],
       [1438398000],
       [1438408800],
       [1438419600],
       [1438430400],
       [1438441200],
       [1438452000],
       [1438462800],
       [1438473600],
       [1438484400]], dtype=int64)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 3,  0,  9, 41, 39, 27, 12,  4,  3,  4], dtype=int64)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Our prediction task is a regression task.</p></li>
</ul>
<ul class="simple">
<li><p>Let’s try random forest regression with just this feature.</p></li>
<li><p>We’ll be trying out many different features. So we’ll be using the function below which</p>
<ul>
<li><p>Splits the data</p></li>
<li><p>Trains the given regressor model on the training data</p></li>
<li><p>Shows train and test scores</p></li>
<li><p>Plots the predictions on the train and test data</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code credit: Adapted from </span>
<span class="c1"># https://learning.oreilly.com/library/view/introduction-to-machine/9781449369880/</span>

<span class="k">def</span><span class="w"> </span><span class="nf">eval_on_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">n_train</span><span class="o">=</span><span class="mi">184</span><span class="p">,</span> <span class="n">sales_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Rentals&#39;</span><span class="p">,</span> 
                     <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Default&quot;</span><span class="p">,</span> 
                     <span class="n">impute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a regression model on a given set of features and target.</span>

<span class="sd">    This function splits the data into training and test sets, fits the </span>
<span class="sd">    regression model to the training data, and then evaluates and plots </span>
<span class="sd">    the performance of the model on both the training and test datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    features : array-like</span>
<span class="sd">        Input features for the model.</span>
<span class="sd">    target : array-like</span>
<span class="sd">        Target variable for the model.</span>
<span class="sd">    regressor : model object</span>
<span class="sd">        A regression model instance that follows the scikit-learn API.</span>
<span class="sd">    n_train : int, default=184</span>
<span class="sd">        The number of samples to be used in the training set.</span>
<span class="sd">    sales_data : bool, default=False</span>
<span class="sd">        Indicates if the data is sales data, which affects the plot ticks.</span>
<span class="sd">    ylabel : str, default=&#39;Rentals&#39;</span>
<span class="sd">        The label for the y-axis in the plot.</span>
<span class="sd">    feat_names : str, default=&#39;Default&#39;</span>
<span class="sd">        Names of the features used, for display in the plot title.</span>
<span class="sd">    impute : bool, default=True</span>
<span class="sd">        whether SimpleImputer needs to be applied or not</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    None</span>
<span class="sd">        The function does not return any value. It prints the R^2 score</span>
<span class="sd">        and generates a plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Split the features and target data into training and test sets</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">impute</span><span class="p">:</span>
        <span class="n">simp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">simp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">simp</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="c1"># Fit the model on the training data</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Print R^2 scores for training and test datasets</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>

    <span class="c1"># Predict target variable for both training and test datasets</span>
    <span class="n">y_pred_train</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Plotting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1"># If not sales data, adjust x-ticks for dates (assumes datetime format)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sales_data</span><span class="p">:</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">8</span><span class="p">),</span> <span class="n">xticks</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="c1"># Plot training and test data, along with predictions</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">),</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">y_test</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">),</span> <span class="n">y_pred_train</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction train&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction test&quot;</span><span class="p">)</span>

    <span class="c1"># Set plot title, labels, and legend</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Features= &quot;</span> <span class="o">+</span> <span class="n">feat_names</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try random forest regressor with our posix time feature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;POSIX time&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.85
Test-set R^2: -0.04
</pre></div>
</div>
<img alt="../../_images/366743049314ed7fa667634dda05c96a819abd4ebcf2878d8bd7b5c4f48664a4.png" src="../../_images/366743049314ed7fa667634dda05c96a819abd4ebcf2878d8bd7b5c4f48664a4.png" />
</div>
</div>
<ul class="simple">
<li><p>The predictions on the training data and training score are pretty good</p></li>
<li><p>But for the test data, a constant line is predicted …</p></li>
<li><p>What’s going on?
<br><br><br><br></p></li>
</ul>
<ul class="simple">
<li><p>The model is based on only one feature: POSIX time feature.</p></li>
<li><p>And the value of the POSIX time feature is outside the range of the feature values in the training set.</p></li>
<li><p>Tree-based models cannot <em>extrapolate</em> to feature ranges outside the training data.</p></li>
<li><p>The model predicted the target value of the closest point in the training set.</p></li>
</ul>
<p>Can we come up with better features?</p>
</section>
<section id="extracting-date-and-time-information">
<h3>Extracting date and time information<a class="headerlink" href="#extracting-date-and-time-information" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Note that our index is of this special type: <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DatetimeIndex.html"><code class="docutils literal notranslate"><span class="pre">DateTimeIndex</span></code></a>. We can extract all kinds of interesting information from it.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2015-08-01 00:00:00&#39;, &#39;2015-08-01 03:00:00&#39;,
               &#39;2015-08-01 06:00:00&#39;, &#39;2015-08-01 09:00:00&#39;,
               &#39;2015-08-01 12:00:00&#39;, &#39;2015-08-01 15:00:00&#39;,
               &#39;2015-08-01 18:00:00&#39;, &#39;2015-08-01 21:00:00&#39;,
               &#39;2015-08-02 00:00:00&#39;, &#39;2015-08-02 03:00:00&#39;,
               ...
               &#39;2015-08-30 18:00:00&#39;, &#39;2015-08-30 21:00:00&#39;,
               &#39;2015-08-31 00:00:00&#39;, &#39;2015-08-31 03:00:00&#39;,
               &#39;2015-08-31 06:00:00&#39;, &#39;2015-08-31 09:00:00&#39;,
               &#39;2015-08-31 12:00:00&#39;, &#39;2015-08-31 15:00:00&#39;,
               &#39;2015-08-31 18:00:00&#39;, &#39;2015-08-31 21:00:00&#39;],
              dtype=&#39;datetime64[ns]&#39;, name=&#39;starttime&#39;, length=248, freq=&#39;3h&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;,
       &#39;August&#39;, &#39;August&#39;, &#39;August&#39;,
       ...
       &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;,
       &#39;August&#39;, &#39;August&#39;, &#39;August&#39;],
      dtype=&#39;object&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([5, 5, 5, 5, 5, 5, 5, 5, 6, 6,
       ...
       6, 6, 0, 0, 0, 0, 0, 0, 0, 0],
      dtype=&#39;int32&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;,
       &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Sunday&#39;, &#39;Sunday&#39;,
       ...
       &#39;Sunday&#39;, &#39;Sunday&#39;, &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;,
       &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;],
      dtype=&#39;object&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([ 0,  3,  6,  9, 12, 15, 18, 21,  0,  3,
       ...
       18, 21,  0,  3,  6,  9, 12, 15, 18, 21],
      dtype=&#39;int32&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We noted before that the time of the day and day of the week seem quite important.</p></li>
<li><p>Let’s add these two features.</p></li>
</ul>
<p>Let’s first add the time of the day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour</span> <span class="o">=</span> <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">X_hour</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0],
       [ 3],
       [ 6],
       [ 9],
       [12],
       [15],
       [18],
       [21],
       [ 0],
       [ 3]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;Hour of the day&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.50
Test-set R^2: 0.60
</pre></div>
</div>
<img alt="../../_images/a2d9cea3cbf96419bc649c2cf1d99a9ae60b1f392eee12016878d0b5d68a5ca6.png" src="../../_images/a2d9cea3cbf96419bc649c2cf1d99a9ae60b1f392eee12016878d0b5d68a5ca6.png" />
</div>
</div>
<p>The scores are better when we add time of the day feature.</p>
<p>Now let’s add day of the week along with time of the day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X_hour_week</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day + day of week&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.89
Test-set R^2: 0.84
</pre></div>
</div>
<img alt="../../_images/d2355a8f1053468e568a760b5839fd05930b0b17b06a9997d60c0152d8dc93d3.png" src="../../_images/d2355a8f1053468e568a760b5839fd05930b0b17b06a9997d60c0152d8dc93d3.png" />
</div>
</div>
<p>The results are much better. The time of the day and day of the week features are clearly helping.</p>
<ul class="simple">
<li><p>Do we need a complex model such as a random forest?</p></li>
<li><p>Let’s try <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> with these features.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">();</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day + day of week&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.16
Test-set R^2: 0.13
</pre></div>
</div>
<img alt="../../_images/3a54d497eae39697c5cd34a20e69c540c085eb2bdecefd0e38d24acb24e49a14.png" src="../../_images/3a54d497eae39697c5cd34a20e69c540c085eb2bdecefd0e38d24acb24e49a14.png" />
</div>
</div>
</section>
<section id="id2">
<h3>❓❓ Questions for you<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Why is <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> performing poorly on the training data as well as test data?</p></li>
</ul>
<p><br><br><br><br><br><br><br><br></p>
</section>
<section id="encoding-time-of-day-as-a-categorical-feature">
<h3>Encoding time of day as a categorical feature<a class="headerlink" href="#encoding-time-of-day-as-a-categorical-feature" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Ridge</span></code> is performing poorly because it’s not able to capture the periodic pattern.</p></li>
<li><p>The reason is that we have encoded time of day using integers.</p></li>
<li><p>A linear function can only learn a linear function of the time of day.</p></li>
<li><p>What if we encode this feature as a categorical variable?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">X_hour_week_onehot</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot</span>
<span class="n">X_hour_week_onehot</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hour</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">hour</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
      <th>00:00</th>
      <th>03:00</th>
      <th>06:00</th>
      <th>09:00</th>
      <th>12:00</th>
      <th>15:00</th>
      <th>18:00</th>
      <th>21:00</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>244</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>245</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>246</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>247</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 15 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">(),</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;hour of day OHE + day of week OHE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.53
Test-set R^2: 0.62
</pre></div>
</div>
<img alt="../../_images/f58b79ee2894b20ffc0be2f2f26268a0c116ee2b1685da47898c4fd27cb84d83.png" src="../../_images/f58b79ee2894b20ffc0be2f2f26268a0c116ee2b1685da47898c4fd27cb84d83.png" />
</div>
</div>
<ul class="simple">
<li><p>The scores are a bit better now.</p></li>
<li><p>What if we add interaction features (e.g., something like Day == Mon and hour == 9:00)</p></li>
<li><p>We can do it using <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>’s <code class="docutils literal notranslate"><span class="pre">PolynomialFeatures</span></code> transformer.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolynomialFeatures</span>

<span class="n">poly_transformer</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span>
    <span class="n">interaction_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">X_hour_week_onehot_poly</span> <span class="o">=</span> <span class="n">poly_transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hour</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">hour</span>
<span class="n">features_poly</span> <span class="o">=</span> <span class="n">poly_transformer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">features_poly</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Mon&#39;, &#39;Tue&#39;, &#39;Wed&#39;, &#39;Thu&#39;, &#39;Fri&#39;, &#39;Sat&#39;, &#39;Sun&#39;, &#39;00:00&#39;, &#39;03:00&#39;,
       &#39;06:00&#39;, &#39;09:00&#39;, &#39;12:00&#39;, &#39;15:00&#39;, &#39;18:00&#39;, &#39;21:00&#39;, &#39;Mon Tue&#39;,
       &#39;Mon Wed&#39;, &#39;Mon Thu&#39;, &#39;Mon Fri&#39;, &#39;Mon Sat&#39;, &#39;Mon Sun&#39;, &#39;Mon 00:00&#39;,
       &#39;Mon 03:00&#39;, &#39;Mon 06:00&#39;, &#39;Mon 09:00&#39;, &#39;Mon 12:00&#39;, &#39;Mon 15:00&#39;,
       &#39;Mon 18:00&#39;, &#39;Mon 21:00&#39;, &#39;Tue Wed&#39;, &#39;Tue Thu&#39;, &#39;Tue Fri&#39;,
       &#39;Tue Sat&#39;, &#39;Tue Sun&#39;, &#39;Tue 00:00&#39;, &#39;Tue 03:00&#39;, &#39;Tue 06:00&#39;,
       &#39;Tue 09:00&#39;, &#39;Tue 12:00&#39;, &#39;Tue 15:00&#39;, &#39;Tue 18:00&#39;, &#39;Tue 21:00&#39;,
       &#39;Wed Thu&#39;, &#39;Wed Fri&#39;, &#39;Wed Sat&#39;, &#39;Wed Sun&#39;, &#39;Wed 00:00&#39;,
       &#39;Wed 03:00&#39;, &#39;Wed 06:00&#39;, &#39;Wed 09:00&#39;, &#39;Wed 12:00&#39;, &#39;Wed 15:00&#39;,
       &#39;Wed 18:00&#39;, &#39;Wed 21:00&#39;, &#39;Thu Fri&#39;, &#39;Thu Sat&#39;, &#39;Thu Sun&#39;,
       &#39;Thu 00:00&#39;, &#39;Thu 03:00&#39;, &#39;Thu 06:00&#39;, &#39;Thu 09:00&#39;, &#39;Thu 12:00&#39;,
       &#39;Thu 15:00&#39;, &#39;Thu 18:00&#39;, &#39;Thu 21:00&#39;, &#39;Fri Sat&#39;, &#39;Fri Sun&#39;,
       &#39;Fri 00:00&#39;, &#39;Fri 03:00&#39;, &#39;Fri 06:00&#39;, &#39;Fri 09:00&#39;, &#39;Fri 12:00&#39;,
       &#39;Fri 15:00&#39;, &#39;Fri 18:00&#39;, &#39;Fri 21:00&#39;, &#39;Sat Sun&#39;, &#39;Sat 00:00&#39;,
       &#39;Sat 03:00&#39;, &#39;Sat 06:00&#39;, &#39;Sat 09:00&#39;, &#39;Sat 12:00&#39;, &#39;Sat 15:00&#39;,
       &#39;Sat 18:00&#39;, &#39;Sat 21:00&#39;, &#39;Sun 00:00&#39;, &#39;Sun 03:00&#39;, &#39;Sun 06:00&#39;,
       &#39;Sun 09:00&#39;, &#39;Sun 12:00&#39;, &#39;Sun 15:00&#39;, &#39;Sun 18:00&#39;, &#39;Sun 21:00&#39;,
       &#39;00:00 03:00&#39;, &#39;00:00 06:00&#39;, &#39;00:00 09:00&#39;, &#39;00:00 12:00&#39;,
       &#39;00:00 15:00&#39;, &#39;00:00 18:00&#39;, &#39;00:00 21:00&#39;, &#39;03:00 06:00&#39;,
       &#39;03:00 09:00&#39;, &#39;03:00 12:00&#39;, &#39;03:00 15:00&#39;, &#39;03:00 18:00&#39;,
       &#39;03:00 21:00&#39;, &#39;06:00 09:00&#39;, &#39;06:00 12:00&#39;, &#39;06:00 15:00&#39;,
       &#39;06:00 18:00&#39;, &#39;06:00 21:00&#39;, &#39;09:00 12:00&#39;, &#39;09:00 15:00&#39;,
       &#39;09:00 18:00&#39;, &#39;09:00 21:00&#39;, &#39;12:00 15:00&#39;, &#39;12:00 18:00&#39;,
       &#39;12:00 21:00&#39;, &#39;15:00 18:00&#39;, &#39;15:00 21:00&#39;, &#39;18:00 21:00&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hour_week_ohe_poly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">features_poly</span><span class="p">)</span>
<span class="n">df_hour_week_ohe_poly</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
      <th>00:00</th>
      <th>03:00</th>
      <th>06:00</th>
      <th>...</th>
      <th>09:00 12:00</th>
      <th>09:00 15:00</th>
      <th>09:00 18:00</th>
      <th>09:00 21:00</th>
      <th>12:00 15:00</th>
      <th>12:00 18:00</th>
      <th>12:00 21:00</th>
      <th>15:00 18:00</th>
      <th>15:00 21:00</th>
      <th>18:00 21:00</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>244</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>245</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>246</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>247</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 120 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot_poly</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248, 120)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day OHE + day of week OHE + interaction feats&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.87
Test-set R^2: 0.85
</pre></div>
</div>
<img alt="../../_images/332d5e5480e3406957203f4e416696fb9c1d4db85e8a866f02bf5deda2c38416.png" src="../../_images/332d5e5480e3406957203f4e416696fb9c1d4db85e8a866f02bf5deda2c38416.png" />
</div>
</div>
<p>The scores are much better now. Since we are using a linear model, we can examine the coefficients learned by <code class="docutils literal notranslate"><span class="pre">Ridge</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features_poly</span><span class="p">)[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">coef_nonzero</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coef_nonzero</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">features_nonzero</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Sat 09:00</th>
      <td>15.196739</td>
    </tr>
    <tr>
      <th>Wed 06:00</th>
      <td>15.005809</td>
    </tr>
    <tr>
      <th>Sat 12:00</th>
      <td>13.437684</td>
    </tr>
    <tr>
      <th>Sun 12:00</th>
      <td>13.362009</td>
    </tr>
    <tr>
      <th>Thu 06:00</th>
      <td>10.907595</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Sat 21:00</th>
      <td>-6.085150</td>
    </tr>
    <tr>
      <th>00:00</th>
      <td>-11.693898</td>
    </tr>
    <tr>
      <th>03:00</th>
      <td>-12.111220</td>
    </tr>
    <tr>
      <th>Sat 06:00</th>
      <td>-13.757591</td>
    </tr>
    <tr>
      <th>Sun 06:00</th>
      <td>-18.033267</td>
    </tr>
  </tbody>
</table>
<p>71 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>The coefficients make sense!</p></li>
<li><p>If it’s Saturday 09:00 or Wednesday 06:00, the model is likely to predict bigger number for rentals.</p></li>
<li><p>If it’s Midnight or 03:00 or Sunday 06:00, the model is likely to predict smaller number for rentals.</p></li>
</ul>
</section>
<section id="interim-summary">
<h3>Interim summary<a class="headerlink" href="#interim-summary" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Success in time-series analysis heavily relies on the appropriate choice of models and features.</p></li>
<li><p>Tree-based models cannot extrapolate; caution is needed when using them with linear integer features.</p></li>
<li><p>Linear models struggle with cyclic patterns in numeric features (e.g., numerically encoded time of the day feature) because these patterns are inherently non-linear.</p></li>
<li><p>Applying one-hot encoding on such features transforms cyclic temporal features into a format where their impact on the target variable can be independently and linearly modeled, enabling linear models to effectively capture and use these cyclic patterns.</p></li>
</ul>
<p><br><br></p>
</section>
</section>
<section id="lag-based-features">
<h2>Lag-based features<a class="headerlink" href="#lag-based-features" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>So far we engineered some features and managed to get reasonable results.</p></li>
<li><p>In time series data there is temporal dependence; observations close in time tend to be correlated.</p></li>
<li><p>Currently we’re using current time to predict the number of bike rentals in the next three hours.</p></li>
<li><p>But, what if the number of bike rentals is also related to bike rentals three hours ago or 6 hours ago and so on?</p>
<ul>
<li><p>Such features are called <em>lagged</em> features.</p></li>
</ul>
</li>
</ul>
<p><em>Note: In time series analysis, you would look at something called an <a class="reference external" href="https://en.wikipedia.org/wiki/Autocorrelation">autocorrelation function</a> (ACF), but we won’t go into that here.</em></p>
<p>Let’s extract lag features. We can “lag” (or “shift”) a time series in Pandas with the <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-01 00:00:00     3
2015-08-01 03:00:00     0
2015-08-01 06:00:00     9
2015-08-01 09:00:00    41
2015-08-01 12:00:00    39
                       ..
2015-08-31 09:00:00    16
2015-08-31 12:00:00     8
2015-08-31 15:00:00    17
2015-08-31 18:00:00    22
2015-08-31 21:00:00     7
Freq: 3h, Name: one, Length: 248, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">citibike</span><span class="p">)</span>
<span class="n">rentals_df</span> <span class="o">=</span> <span class="n">rentals_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;one&quot;</span><span class="p">:</span><span class="s2">&quot;n_rentals&quot;</span><span class="p">})</span>
<span class="n">rentals_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-01 00:00:00</th>
      <td>3</td>
    </tr>
    <tr>
      <th>2015-08-01 03:00:00</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2015-08-01 06:00:00</th>
      <td>9</td>
    </tr>
    <tr>
      <th>2015-08-01 09:00:00</th>
      <td>41</td>
    </tr>
    <tr>
      <th>2015-08-01 12:00:00</th>
      <td>39</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>16</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>8</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>17</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>22</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>7</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_lag_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5</span> <span class="o">=</span> <span class="n">create_lag_df</span><span class="p">(</span><span class="n">rentals_df</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals</th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-01 00:00:00</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 03:00:00</th>
      <td>0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 06:00:00</th>
      <td>9</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 09:00:00</th>
      <td>41</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 12:00:00</th>
      <td>39</td>
      <td>41.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>16</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>8</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>17</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>22</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>7</td>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 6 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Note the NaN pattern.</p></li>
<li><p>We can either drop the first 5 rows or apply imputation.</p></li>
<li><p>Let’s try these features with <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> model.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_lag_features</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">X_lag_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[nan, nan, nan, nan, nan],
       [ 3., nan, nan, nan, nan],
       [ 0.,  3., nan, nan, nan],
       ...,
       [ 8., 16., 36.,  2.,  3.],
       [17.,  8., 16., 36.,  2.],
       [22., 17.,  8., 16., 36.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_lag_features</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Lag features&quot;</span><span class="p">,</span> <span class="n">impute</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.25
Test-set R^2: 0.37
</pre></div>
</div>
<img alt="../../_images/5b48a870ae20c927d83aba6fba8dcb60e504ea05040ffef26660f012f690e3fd.png" src="../../_images/5b48a870ae20c927d83aba6fba8dcb60e504ea05040ffef26660f012f690e3fd.png" />
</div>
</div>
<p>The results are not great. But let’s examine the coefficients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_lag</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">features_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features_lag</span><span class="p">)[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">coef_nonzero</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coef_nonzero</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">features_nonzero</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>n_rentals-1</th>
      <td>0.165617</td>
    </tr>
    <tr>
      <th>n_rentals-4</th>
      <td>-0.048630</td>
    </tr>
    <tr>
      <th>n_rentals-2</th>
      <td>-0.214821</td>
    </tr>
    <tr>
      <th>n_rentals-3</th>
      <td>-0.258225</td>
    </tr>
    <tr>
      <th>n_rentals-5</th>
      <td>-0.373656</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>How about <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor</span></code> model?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
<span class="n">X_lag_features_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_lag_features</span><span class="p">)</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_lag_features_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Lag features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.94
Test-set R^2: 0.70
</pre></div>
</div>
<img alt="../../_images/4293dd185f933eb9fbc020efbd38dc69b4a95a96ae9d6e644762a5da9dc9ca23.png" src="../../_images/4293dd185f933eb9fbc020efbd38dc69b4a95a96ae9d6e644762a5da9dc9ca23.png" />
</div>
</div>
<p>The results are better than <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> with lag features but they are not as good as the results with our previously engineered features. How about combining lag-based features and the previously extracted features?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot_poly_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">X_lag_features</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly_lag</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day OHE + day of week OHE + interaction feats + Lag feats&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.96
Test-set R^2: 0.78
</pre></div>
</div>
<img alt="../../_images/a2170039611a2bdd3b01cfc75378b5fa98c45a8a44fd2c96470e624d94e82683.png" src="../../_images/a2170039611a2bdd3b01cfc75378b5fa98c45a8a44fd2c96470e624d94e82683.png" />
</div>
</div>
<p>Some improvement but we are getting better results without the lag features in this case.</p>
<section id="cross-validation">
<h3>Cross-validation<a class="headerlink" href="#cross-validation" title="Link to this heading">#</a></h3>
<p>What about cross-validation?</p>
<ul class="simple">
<li><p>We can’t do regular cross-validation if we don’t want to be predicting the past.</p></li>
<li><p>If you carry out regular cross-validation, as shown below, you’ll be predicting the past given future which is not a realistic scenario for the deployment data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mglearn</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">plot_cross_validation</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/333641c663496c1c15ba48b3791b0b8dde57f29205e256a6c14a3b62629b0852.png" src="../../_images/333641c663496c1c15ba48b3791b0b8dde57f29205e256a6c14a3b62629b0852.png" />
</div>
</div>
<p>There is <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.TimeSeriesSplit.html"><code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code></a> for time series data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code from sklearn documentation</span>
<span class="n">X_toy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
<span class="n">y_toy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_toy</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2] [3]
[0 1 2 3] [4]
[0 1 2 3 4] [5]
</pre></div>
</div>
</div>
</div>
<p>Let’s try it out with Ridge on the bike rental data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">lr</span><span class="p">,</span> <span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">TimeSeriesSplit</span><span class="p">(),</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_score</th>
      <th>train_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.003995</td>
      <td>0.001506</td>
      <td>0.642676</td>
      <td>0.873182</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.003414</td>
      <td>0.000995</td>
      <td>0.828405</td>
      <td>0.874305</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.003002</td>
      <td>0.001003</td>
      <td>0.773851</td>
      <td>0.901262</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.001510</td>
      <td>0.001519</td>
      <td>0.696712</td>
      <td>0.889429</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.005659</td>
      <td>0.001011</td>
      <td>0.892733</td>
      <td>0.863889</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><br><br><br><br></p>
</section>
</section>
<section id="forecasting-further-into-the-future">
<h2>Forecasting further into the future<a class="headerlink" href="#forecasting-further-into-the-future" title="Link to this heading">#</a></h2>
<p>Recall that we are working with the bike rentals data from August 2015.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-01 00:00:00     3
2015-08-01 03:00:00     0
2015-08-01 06:00:00     9
2015-08-01 09:00:00    41
2015-08-01 12:00:00    39
                       ..
2015-08-31 09:00:00    16
2015-08-31 12:00:00     8
2015-08-31 15:00:00    17
2015-08-31 18:00:00    22
2015-08-31 21:00:00     7
Freq: 3h, Name: one, Length: 248, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Here is our data with lag features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals</th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-01 00:00:00</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 03:00:00</th>
      <td>0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 06:00:00</th>
      <td>9</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 09:00:00</th>
      <td>41</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 12:00:00</th>
      <td>39</td>
      <td>41.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>16</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>8</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>17</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>22</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>7</td>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 6 columns</p>
</div></div></div>
</div>
<p>Let’s impute the data and create <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
<span class="n">X_lag_features_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_lag_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_lag_features_imp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">rentals_lag5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">rentals_lag5_X</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="o">.</span><span class="n">index</span>
<span class="n">rentals_lag5_X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-01 00:00:00</th>
      <td>17.024291</td>
      <td>17.004065</td>
      <td>17.004082</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>2015-08-01 03:00:00</th>
      <td>3.000000</td>
      <td>17.004065</td>
      <td>17.004082</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>2015-08-01 06:00:00</th>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>17.004082</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>2015-08-01 09:00:00</th>
      <td>9.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>2015-08-01 12:00:00</th>
      <td>41.000000</td>
      <td>9.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>36.000000</td>
      <td>2.000000</td>
      <td>3.000000</td>
      <td>6.000000</td>
      <td>37.000000</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>2.000000</td>
      <td>3.000000</td>
      <td>6.000000</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>8.000000</td>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>2.000000</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>17.000000</td>
      <td>8.000000</td>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>22.000000</td>
      <td>17.000000</td>
      <td>8.000000</td>
      <td>16.000000</td>
      <td>36.000000</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5_y</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s split the data and train a linear model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the given features into a training and a test set</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="mi">184</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">rentals_lag5_X</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">rentals_lag5_X</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
<span class="c1"># also split the target array</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">rentals_lag5_y</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">rentals_lag5_y</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rentals_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rentals_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rentals_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.94
Test-set R^2: 0.68
</pre></div>
</div>
</div>
</div>
<p>Given this, we can now predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> on the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-24 00:00:00</th>
      <td>12.0</td>
      <td>31.0</td>
      <td>58.0</td>
      <td>30.0</td>
      <td>23.0</td>
    </tr>
    <tr>
      <th>2015-08-24 03:00:00</th>
      <td>2.0</td>
      <td>12.0</td>
      <td>31.0</td>
      <td>58.0</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>2015-08-24 06:00:00</th>
      <td>3.0</td>
      <td>2.0</td>
      <td>12.0</td>
      <td>31.0</td>
      <td>58.0</td>
    </tr>
    <tr>
      <th>2015-08-24 09:00:00</th>
      <td>27.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>12.0</td>
      <td>31.0</td>
    </tr>
    <tr>
      <th>2015-08-24 12:00:00</th>
      <td>6.0</td>
      <td>27.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>64 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">rentals_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">preds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 6.36,  4.73, 16.84,  8.71, 13.  , 24.34, 23.91, 12.07,  5.44,
        2.11, 42.31, 11.64, 28.09, 26.46, 25.41, 12.28, 11.89,  2.01,
       34.5 ,  8.34, 23.94, 25.2 , 26.63, 11.02,  2.67,  2.71, 26.72,
        9.96, 24.42, 23.05, 26.79, 14.17,  3.22,  1.51,  9.15,  8.83,
       21.12, 24.7 , 25.23, 10.04,  2.21,  2.29, 22.45, 28.03, 36.14,
       32.83, 21.45,  5.8 ,  3.43,  3.18, 21.72, 26.23, 40.37, 34.84,
       27.67, 14.79,  5.44,  4.45, 20.19, 14.49, 23.06, 20.34, 23.02,
       10.11])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test_preds</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">predicted_n_rentals</span><span class="o">=</span><span class="n">preds</span><span class="p">)</span>
<span class="n">X_test_preds</span> <span class="o">=</span> <span class="n">X_test_preds</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">n_rentals</span><span class="o">=</span><span class="n">y_test</span><span class="p">)</span>
<span class="n">X_test_preds</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
      <th>predicted_n_rentals</th>
      <th>n_rentals</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
      <td>14.49</td>
      <td>16</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>23.06</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>20.34</td>
      <td>17</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>23.02</td>
      <td>22</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>10.11</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Ok, that is fine, but what if we want to predict 15 hours in the future? In other words, what if we want to predict number of rentals for the next three hours at time 2015-09-01 12:00:00?</p></li>
<li><p>Well, we would not have access to our lag features!! We don’t yet know <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for</p>
<ul>
<li><p>2015-09-01 00:00:00</p></li>
<li><p>2015-09-01 03:00:00</p></li>
<li><p>2015-09-01 06:00:00</p></li>
<li><p>2015-09-01 09:00:00</p></li>
</ul>
</li>
</ul>
<p>There are a few approaches which could be employed:</p>
<ol class="arabic simple">
<li><p>Train a separate model for each number of 3-hour span. E.g. one model that predicts <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for next three hours, another model that predicts <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> in six hours, etc. We can build these datasets.</p></li>
<li><p>Use a multi-output model that jointly predicts <code class="docutils literal notranslate"><span class="pre">n_rentalsIn3hours</span></code>, <code class="docutils literal notranslate"><span class="pre">n_rentalsIn6hours</span></code>, etc. However, multi-output models are outside the scope of CPSC 330.</p></li>
<li><p>Use one model and sequentially predict using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop.</p></li>
</ol>
<p>If we decide to use approach 3, we would predict these values and then pretend they are true! For example, given that it’s August 31st 2015 at 21:00.</p>
<ol class="arabic simple">
<li><p>Predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 00:00.</p></li>
<li><p>Then to predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 03:00, we need to know <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 00:00. Use our <em>prediction</em> for September 1st 2015 at 00:00 as the truth.</p></li>
<li><p>Then, to predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 06:00, we need to know <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 00:00 and <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 03:00. Use our predictions.</p></li>
<li><p>Etc etc.</p></li>
</ol>
<p><br><br><br><br></p>
<section id="forecasting-further-into-the-future-on-a-retail-dataset">
<h3>Forecasting further into the future on a retail dataset<a class="headerlink" href="#forecasting-further-into-the-future-on-a-retail-dataset" title="Link to this heading">#</a></h3>
<p>Let’s consider another time series dataset, <a class="reference external" href="https://fred.stlouisfed.org/series/MRTSSM448USN">Retail Sales of Clothing and Clothing Accessory Stores dataset</a> which is made available by the Federal Reserve Bank of St. Louis.</p>
<p>The dataset has dates and retail sales values corresponding to the dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">+</span> <span class="s2">&quot;MRTSSM448USN.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">])</span>
<span class="n">retail_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sales&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s examine the min and max dates in order to split the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;1992-01-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2022-09-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<p>I’m considering everything upto 01 January 2016 as training data and everything after that as test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span> <span class="o">=</span> <span class="n">retail_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &lt;= 20160101&quot;</span><span class="p">)</span>
<span class="n">retail_df_test</span> <span class="o">=</span> <span class="n">retail_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &gt;  20160101&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b0f52b8232bc7cc8aaece72ba776ea52bf7682fc623907d02837efdc6e649b39.png" src="../../_images/b0f52b8232bc7cc8aaece72ba776ea52bf7682fc623907d02837efdc6e649b39.png" />
</div>
</div>
<p>We can create a dataset using purely lag features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">lag_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s create lag features for the full dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_lag_5</span> <span class="o">=</span> <span class="n">lag_df</span><span class="p">(</span><span class="n">retail_df</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &lt;= 20160101&quot;</span><span class="p">)</span>
<span class="n">retail_test_5</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &gt;  20160101&quot;</span><span class="p">)</span>
<span class="n">retail_train_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>284</th>
      <td>2015-09-01</td>
      <td>19266</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
      <td>20485.0</td>
    </tr>
    <tr>
      <th>285</th>
      <td>2015-10-01</td>
      <td>20794</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
    </tr>
    <tr>
      <th>286</th>
      <td>2015-11-01</td>
      <td>23175</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
    </tr>
    <tr>
      <th>287</th>
      <td>2015-12-01</td>
      <td>33590</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
    </tr>
    <tr>
      <th>288</th>
      <td>2016-01-01</td>
      <td>15775</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
    </tr>
  </tbody>
</table>
<p>289 rows × 7 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now, if we drop the “date” column we have a target (“sales”) and 5 features (the previous 5 days of sales).</p></li>
<li><p>We need to impute/drop the missing values and then we can fit a model to this. I will just drop for convenience:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">retail_train_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>9182</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9103</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10513</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9573</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10254</td>
      <td>9573.0</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>284</th>
      <td>19266</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
      <td>20485.0</td>
    </tr>
    <tr>
      <th>285</th>
      <td>20794</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
    </tr>
    <tr>
      <th>286</th>
      <td>23175</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
    </tr>
    <tr>
      <th>287</th>
      <td>33590</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
    </tr>
    <tr>
      <th>288</th>
      <td>15775</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
    </tr>
  </tbody>
</table>
<p>284 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5_X</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">])</span>
<span class="n">retail_train_5_y</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">retail_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">retail_train_5_X</span><span class="p">,</span> <span class="n">retail_train_5_y</span><span class="p">);</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retail_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">retail_train_5_X</span><span class="p">,</span> <span class="n">retail_train_5_y</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.96
</pre></div>
</div>
</div>
</div>
<p>Given this, we can now predict the sales</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_test_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>289</th>
      <td>2016-02-01</td>
      <td>19032</td>
      <td>15775.0</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
    </tr>
    <tr>
      <th>290</th>
      <td>2016-03-01</td>
      <td>21581</td>
      <td>19032.0</td>
      <td>15775.0</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
    </tr>
    <tr>
      <th>291</th>
      <td>2016-04-01</td>
      <td>20514</td>
      <td>21581.0</td>
      <td>19032.0</td>
      <td>15775.0</td>
      <td>33590.0</td>
      <td>23175.0</td>
    </tr>
    <tr>
      <th>292</th>
      <td>2016-05-01</td>
      <td>21774</td>
      <td>20514.0</td>
      <td>21581.0</td>
      <td>19032.0</td>
      <td>15775.0</td>
      <td>33590.0</td>
    </tr>
    <tr>
      <th>293</th>
      <td>2016-06-01</td>
      <td>20274</td>
      <td>21774.0</td>
      <td>20514.0</td>
      <td>21581.0</td>
      <td>19032.0</td>
      <td>15775.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>364</th>
      <td>2022-05-01</td>
      <td>26831</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
      <td>39375.0</td>
    </tr>
    <tr>
      <th>365</th>
      <td>2022-06-01</td>
      <td>25031</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
    </tr>
    <tr>
      <th>366</th>
      <td>2022-07-01</td>
      <td>25214</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
    </tr>
    <tr>
      <th>367</th>
      <td>2022-08-01</td>
      <td>26376</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
    </tr>
    <tr>
      <th>368</th>
      <td>2022-09-01</td>
      <td>23941</td>
      <td>26376.0</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
    </tr>
  </tbody>
</table>
<p>80 rows × 7 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">retail_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">retail_test_5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sales&quot;</span><span class="p">]))</span>
<span class="n">preds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([17896.8 , 21694.77, 21603.92, 21847.23, 21405.8 , 20564.86,
       22154.04, 26063.73, 21389.05, 22320.42, 30167.05, 16153.78,
       18096.6 , 20310.9 , 21353.73, 22826.97, 21697.73, 21549.23,
       21768.07, 27206.55, 21571.78, 22057.72, 28953.14, 16160.1 ,
       18000.99, 21596.28, 22910.96, 22225.52, 28327.52, 20620.57,
       22114.07, 30279.79, 21605.25, 21668.73, 18313.24, 16153.78,
       18245.22, 20319.6 , 23290.45, 22788.29, 28362.34, 22219.81,
       21530.08, 29881.14, 21617.54, 21670.38, 19380.36, 16157.83,
       18955.53, 22078.43, 13107.93, 11057.81, 10910.98, 15429.94,
       13255.13, 10868.94, 18311.55, 21274.73, 23902.03, 14813.7 ,
       17518.48, 18533.12, 30146.97, 29691.79, 15661.24, 27638.52,
       19365.48, 25176.  , 27021.21, 28854.11, 15915.6 , 16358.48,
       20334.54, 22550.67, 18116.77, 17144.95, 16533.7 , 25037.25,
       19365.48, 17205.11])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_test_5_preds</span> <span class="o">=</span> <span class="n">retail_test_5</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">predicted_sales</span><span class="o">=</span><span class="n">preds</span><span class="p">)</span>
<span class="n">retail_test_5_preds</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
      <th>predicted_sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>364</th>
      <td>2022-05-01</td>
      <td>26831</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
      <td>39375.0</td>
      <td>17144.95</td>
    </tr>
    <tr>
      <th>365</th>
      <td>2022-06-01</td>
      <td>25031</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
      <td>16533.70</td>
    </tr>
    <tr>
      <th>366</th>
      <td>2022-07-01</td>
      <td>25214</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>25037.25</td>
    </tr>
    <tr>
      <th>367</th>
      <td>2022-08-01</td>
      <td>26376</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>19365.48</td>
    </tr>
    <tr>
      <th>368</th>
      <td>2022-09-01</td>
      <td>23941</td>
      <td>26376.0</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>17205.11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now what if we want to predict 5 months in the future?</p></li>
<li><p>We would not have access to our features!! We don’t yet know the previous months sales, or two months prior!</p></li>
</ul>
<p>If we decide to use approach 3 from above, we would predict these values and then pretend they are true! For example, given that it’s November 2022</p>
<ol class="arabic simple">
<li><p>Predict December 2022 sales</p></li>
<li><p>Then, to predict for January 2023, we need to know December 2022 sales. Use our <em>prediction</em> for December 2022 as the truth.</p></li>
<li><p>Then, to predict for February 2023, we need to know December 2022 and January 2023 sales. Use our predictions.</p></li>
<li><p>Etc etc.</p></li>
</ol>
<p><br><br></p>
</section>
<section id="seasonality-and-trends">
<h3>Seasonality and trends<a class="headerlink" href="#seasonality-and-trends" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>There are some important concepts in time series that rely on having a continuous target (like we do in the retail sales example above).</p></li>
<li><p>Part of that is the idea of seasonality and trends.</p></li>
<li><p>These are mostly taken care of by our feature engineering of the data variable, but there’s something important left to discuss.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b0f52b8232bc7cc8aaece72ba776ea52bf7682fc623907d02837efdc6e649b39.png" src="../../_images/b0f52b8232bc7cc8aaece72ba776ea52bf7682fc623907d02837efdc6e649b39.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like there’s a <strong>trend</strong> here - the sales are going up over time.</p></li>
</ul>
<p>Let’s say we encoded the date as a feature in days like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5_date</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &lt;= 20160101&quot;</span><span class="p">)</span>
<span class="n">first_day_retail</span> <span class="o">=</span> <span class="n">retail_train_5_date</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">retail_train_5_date</span> <span class="o">=</span> <span class="n">retail_train_5_date</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">Days_since</span><span class="o">=</span><span class="n">retail_train_5_date</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">first_day_retail</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">retail_train_5_date</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
      <th>Days_since</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>31</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>91</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>121</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1992-06-01</td>
      <td>9182</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>152</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1992-07-01</td>
      <td>9103</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>182</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1992-08-01</td>
      <td>10513</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>213</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1992-09-01</td>
      <td>9573</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>244</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1992-10-01</td>
      <td>10254</td>
      <td>9573.0</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>274</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now, let’s say we use all these features (the lagged version of the target and also <code class="docutils literal notranslate"><span class="pre">Days_since</span></code>.</p></li>
<li><p>If we use <strong>linear regression</strong> we’ll learn a coefficient for <code class="docutils literal notranslate"><span class="pre">Days_since</span></code>.</p>
<ul>
<li><p>If that coefficient is positive, it predicts unlimited growth forever. That may not be what you want? It depends.</p></li>
</ul>
</li>
<li><p>If we use a <strong>random forest</strong>, we’ll just be doing splits from the training set, e.g. “if <code class="docutils literal notranslate"><span class="pre">Days_since</span></code> &gt; 9100 then do this”.</p>
<ul>
<li><p>There will be no splits for later time points because there is no training data there.</p></li>
<li><p>Thus tree-based models cannot model trends.</p></li>
<li><p>This is really important to know!!</p></li>
</ul>
</li>
<li><p>Often, we model the trend separately and use the random forest to model a de-trended time series.</p></li>
</ul>
<p><br><br><br><br></p>
</section>
</section>
<section id="final-remarks">
<h2>Final remarks<a class="headerlink" href="#final-remarks" title="Link to this heading">#</a></h2>
<p>What did we not cover?</p>
<ul class="simple">
<li><p>A huge amount!</p></li>
</ul>
<section id="traditional-time-series-approaches">
<h3>Traditional time series approaches<a class="headerlink" href="#traditional-time-series-approaches" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Time series analysis is a huge field of its own</p></li>
<li><p>Traditional approaches include the <a class="reference external" href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA model</a> and its various components/extensions.</p></li>
<li><p>In Python, the <a class="reference external" href="https://www.statsmodels.org/">statsmodels</a> package is the place to go for this sort of thing.</p>
<ul>
<li><p>For example, <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.arima_model.ARIMA.html">statsmodels.tsa.arima_model.ARIMA</a>.</p></li>
</ul>
</li>
<li><p>These approaches can forecast, but they are also very good for understanding the temporal relationships in your data.</p></li>
<li><p>We took different route in this course, and stick to our supervised learning tools.</p></li>
</ul>
</section>
<section id="deep-learning">
<h3>Deep learning<a class="headerlink" href="#deep-learning" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Recently, deep learning has been very successful too.</p></li>
<li><p>In particular, <a class="reference external" href="https://en.wikipedia.org/wiki/Recurrent_neural_network">recurrent neural networks</a> (RNNs).</p>
<ul>
<li><p>These are not covered in CPSC 340, but I believe they are in 540 (soon to be renamed 440).</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTMs</a> especially have shown a lot of promise in this type of task.</p></li>
<li><p><a class="reference external" href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">Here</a> is a blog post about LSTMs.</p></li>
</ul>
</li>
</ul>
</section>
<section id="types-of-problems-involving-time-series">
<h3>Types of problems involving time series<a class="headerlink" href="#types-of-problems-involving-time-series" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>A single label associated with an entire time series.</p>
<ul>
<li><p>We had that with images earlier on, you could have the same for a time series.</p></li>
<li><p>E.g., for fraud detection, labelling each transaction as fraud/normal vs. labelling a person as bad/good based on their entire history.</p></li>
<li><p>There are various approaches that can be used for this type of problem, including CNNs (Lecture 19), LSTMs, and non deep learning methods.</p></li>
</ul>
</li>
<li><p>Inference problems</p>
<ul>
<li><p>What are the patterns in this time series?</p></li>
<li><p>How many lags are associated with the current value?</p></li>
<li><p>Etc.</p></li>
</ul>
</li>
</ul>
<section id="unequally-spaced-time-points">
<h4>Unequally spaced time points<a class="headerlink" href="#unequally-spaced-time-points" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>We assumed we have a measurement each day.</p></li>
<li><p>For example, when creating lag features we used consecutive rows in the DataFrame.</p></li>
<li><p>But, in fact some days were missing in this dataset.</p></li>
<li><p>More generally, what if the measurements are at arbitrary times, not equally spaced?</p>
<ul>
<li><p>Some of our approaches would still work, like encoding the month.</p></li>
<li><p>Some of our approaches would not make sense, like the lags.</p></li>
<li><p>Perhaps the measurements could be binned into equally spaced bins, or something.</p></li>
<li><p>This is more of a hassle.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="other-software-package">
<h3>Other software package<a class="headerlink" href="#other-software-package" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>A good one to know about is <a class="reference external" href="https://facebook.github.io/prophet/docs/quick_start.html">Prophet</a>.</p></li>
<li><p><a class="reference external" href="https://www.sktime.net/en/stable/get_started.html">sktime</a></p>
<ul>
<li><p>Time series classification</p></li>
<li><p>forecasting</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://tslearn.readthedocs.io/en/stable/">tslearn</a></p>
<ul>
<li><p>classification</p></li>
<li><p>regression</p></li>
<li><p>clustering</p></li>
</ul>
</li>
</ul>
</section>
<section id="feature-engineering">
<h3>Feature engineering<a class="headerlink" href="#feature-engineering" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Often, a useful approach is to just <em>engineer your own features</em>.</p>
<ul>
<li><p>E.g., max expenditure, min expenditure, max-min, avg time gap between transactions, variance of time gap between transactions, etc etc.</p></li>
<li><p>We could do that here as well, or in any problem.</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "cpsc330"
        },
        kernelOptions: {
            name: "cpsc330",
            path: "./lectures/101-103-Giulia-lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'cpsc330'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-lo">Imports and LO</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split-for-temporal-data">Train/test split for temporal data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-for-date-time-columns">Feature engineering for date/time columns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#posix-time-feature">POSIX time feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-date-and-time-information">Extracting date and time information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-time-of-day-as-a-categorical-feature">Encoding time of day as a categorical feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interim-summary">Interim summary</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-based-features">Lag-based features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation">Cross-validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future">Forecasting further into the future</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future-on-a-retail-dataset">Forecasting further into the future on a retail dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-and-trends">Seasonality and trends</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-remarks">Final remarks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#traditional-time-series-approaches">Traditional time series approaches</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-learning">Deep learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-problems-involving-time-series">Types of problems involving time series</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#unequally-spaced-time-points">Unequally spaced time points</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-software-package">Other software package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature engineering</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Varada Kolhatkar
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>